---
- name: Disable cloud-init (not needed on bare metal)
  ansible.builtin.file:
    path: /etc/cloud/cloud-init.disabled
    state: touch
    mode: "0644"

- name: Fix interrupted dpkg if needed
  ansible.builtin.command:
    cmd: dpkg --configure -a
  changed_when: false

- name: Update and upgrade apt packages
  ansible.builtin.apt:
    update_cache: true
    upgrade: dist
    cache_valid_time: 3600

- name: Install required packages
  ansible.builtin.apt:
    name:
      - curl
      - apt-transport-https
      - ca-certificates
      - gnupg
      - ufw
      - fail2ban
      - unattended-upgrades
      - open-iscsi
      - nfs-common
    state: present

# --- Swap ---
- name: Disable swap immediately
  ansible.builtin.command:
    cmd: swapoff -a
  changed_when: false

- name: Remove swap entries from /etc/fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '\sswap\s'
    state: absent

# --- Cgroups ---
- name: Enable cgroups in boot config
  ansible.builtin.lineinfile:
    path: /boot/firmware/cmdline.txt
    backrefs: true
    regexp: '^((?!.*cgroup_enable=cpuset).*?)$'
    line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
  notify: reboot node

# --- Kernel modules ---
- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ required_kernel_modules }}"

- name: Persist kernel modules across reboots
  ansible.builtin.copy:
    content: |
      {% for mod in required_kernel_modules %}
      {{ mod }}
      {% endfor %}
    dest: /etc/modules-load.d/k3s.conf
    mode: "0644"

# --- Sysctl ---
- name: Apply sysctl settings for K3s
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-k3s.conf
    reload: true
  loop: "{{ sysctl_settings | dict2items }}"

# --- SSH hardening ---
- name: Harden SSH configuration
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config.d/99-hardening.conf
    mode: "0600"
    validate: "sshd -t -f %s"
  notify: restart sshd

# --- UFW firewall ---
- name: Set UFW default deny incoming
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Set UFW default allow outgoing
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Allow SSH from VLAN 6
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    src: "{{ vlan_cidr }}"

- name: Allow SSH from management network
  community.general.ufw:
    rule: allow
    port: "22"
    proto: tcp
    src: "{{ mgmt_cidr }}"

- name: Allow K3s API server from VLAN 6
  community.general.ufw:
    rule: allow
    port: "6443"
    proto: tcp
    src: "{{ vlan_cidr }}"

- name: Allow K3s API server from management network
  community.general.ufw:
    rule: allow
    port: "6443"
    proto: tcp
    src: "{{ mgmt_cidr }}"

- name: Allow K3s VXLAN (Flannel) from VLAN 6
  community.general.ufw:
    rule: allow
    port: "8472"
    proto: udp
    src: "{{ vlan_cidr }}"

- name: Allow kubelet metrics from VLAN 6
  community.general.ufw:
    rule: allow
    port: "10250"
    proto: tcp
    src: "{{ vlan_cidr }}"

- name: Enable UFW
  community.general.ufw:
    state: enabled

# --- fail2ban ---
- name: Configure fail2ban for SSH
  ansible.builtin.copy:
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 3600
      findtime = 600
    dest: /etc/fail2ban/jail.d/sshd.conf
    mode: "0644"
  notify: restart fail2ban

# --- Unattended upgrades ---
- name: Enable automatic security updates
  ansible.builtin.copy:
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::MinimalSteps "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    mode: "0644"

- name: Enable unattended upgrades periodic check
  ansible.builtin.copy:
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    mode: "0644"
